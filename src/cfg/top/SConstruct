

import os
import sys
import subprocess
import re
import importlib

sys.dont_write_bytecode = True

from utils import *


#-------------------------------------------------------------------------------
#
#    General Settings
#
cfg  = import_config('cfg.yml')
ext  = import_config('filetype.yml')
dirs = import_config('dirpath.yml')

ConfigName = cfg.NAME
DEVICE     = cfg.DEVICE

ip       = ['pll', 'pcie']


#-------------------------------------------------------------------------------
#
#    Environment
#
env = Environment( tools = {} )

env['SETTINGS_SEARCH_PATH'] = [(dirs.CFG_SETTINGS)]

#-------------------------------------------------------------------------------
#
#    Project Structure
#



#-------------------------------------------------------------------------------
#
#    Builders
#

#---------------------------------------------------------------------
#
#    Build Tcl script to create OOC IP
#
def ip_create_script(target, source, env):

    src = str(source[0])
    trg = str(target[0])
    
    print('building Create IP script ' + trg)

    param_sect = 'config'
    
    ip_name = os.path.splitext( os.path.basename(src) )[0]   # derive IP name from full path 
    ip_cfg  = read_ip_config(src, param_sect)
    
    title_text =\
    'IP core "' + ip_name + '" creating script' + os.linesep*2 + \
    'This file is automatically generated. Do not edit the file manually,' + os.linesep + \
    'change parameters of IP in corresponing configuration file (cfg/ip/<IP name>)'
    
    text  = 'set ip_name    ' + ip_name                             + os.linesep*2
    text += 'set DEVICE     ' + cfg.DEVICE                          + os.linesep*2
    text += 'set IP_OOC_DIR ' + dirs.IP_OOC                         + os.linesep
    text += 'set OUT_DIR    [file join ${IP_OOC_DIR} ${ip_name}]'   + os.linesep*2
    text += 'if { [file exists ${OUT_DIR}] } {'                     + os.linesep
    text += '    file delete -force -- ${OUT_DIR}'                  + os.linesep
    text += '}'                                                     + os.linesep*2
    text += 'set_part  ${DEVICE}'                                   + os.linesep
    text += 'create_ip -name ' + ip_cfg['type']
    text += ' -vendor xilinx.com'
    text += ' -library ip'
    text += ' -module_name ${ip_name}'
    text += ' -dir ${IP_OOC_DIR}'                                   + os.linesep*2
    
    ip_params  = ip_cfg[param_sect]
    max_pn_len = max_str_len(ip_params.keys())
    max_pv_len = max_str_len([str(i) for i in ip_params.values()])
    
    for p in ip_params:
        v             = str(ip_params[p])
        name_len      = len(p)
        value_len     = len(v)
        name_padding  = len(param_sect) + max_pn_len - name_len + 2
        value_padding = max_pv_len - value_len + 2
        line  = 'set_property ' + param_sect + '.' + p + ' '*name_padding + v 
        line += ' '*value_padding + '[get_ips ${ip_name}]'
        
        text += line + os.linesep

    text += os.linesep
    text += 'generate_target all [get_ips  ${ip_name}]'             + os.linesep
    text += 'export_ip_user_files -of_objects [get_ips ${ip_name}] '
    text += '-sync -force -quiet'                                   + os.linesep
    text += 'exit'


    out = generate_title(title_text, '#')
    out += text
    out += generate_footer('#')

    #print(out)
    
    with open(trg, 'w') as ofile:
        ofile.write(out)
    
#---------------------------------------------------------------------
#
#    Build Tcl script to synthesize OOC IP
#
def ip_syn_script(target, source, env):

    src = str(source[0])
    trg = str(target[0])

    print('building Synthesize IP script ' + trg)

    with open(src) as src_f:
        ip_create_script = src_f.read()
        
    ip_name = re.findall('set\s+ip_name\s+(\w+)', ip_create_script)[0] # derive IP name from IP create script

    title_text =\
    'IP core "' + ip_name + '" synthesizing script' + os.linesep*2 + \
    'This file is automatically generated. Do not edit the file manually,' + os.linesep + \
    'change parameters of IP in corresponing configuration file (cfg/ip/<IP name>)'

    text  = 'set ip_name    ' + ip_name                             + os.linesep*2
    text += 'set DEVICE     ' + cfg.DEVICE                          + os.linesep*2
    text += 'set IP_OOC_DIR ' + dirs.IP_OOC                         + os.linesep
    text += 'set OUT_DIR    [file join ${IP_OOC_DIR} ${ip_name}]'   + os.linesep*2
    text += 'set_part  ${DEVICE}'                                   + os.linesep
    text += 'read_ip   [file join ${IP_OOC_DIR} ' 
    text += '${ip_name} ${ip_name}.' + ext.IP_CORE +']'             + os.linesep
    text += 'synth_ip  [get_ips ${ip_name}]'                        + os.linesep
    text += 'exit'

    out = generate_title(title_text, '#')
    out += text
    out += generate_footer('#')

    #print(out)

    with open(trg, 'w') as ofile:
        ofile.write(out)

#---------------------------------------------------------------------
#
#    Generate IP
#
def generate_ip(target, source, env):
    pass

#---------------------------------------------------------------------
#
#    Run OOC IP synthesis
#
def ip_core_synthesize(target, source, env):
    pass


#-------------------------------------------------------------------------------
#
#    Scanners
#
#---------------------------------------------------------------------
#
#    Scanner functions
#
def scan_cfg_files(node, env, path):
    
#    print('scan node:', str(node))    
    fname = str(node)
    with open(fname) as f:
        cfg = yaml.safe_load(f)
        
    if 'import' in cfg:
        imports = []
        for i in cfg['import'].split():
            fn = i + '.' + ext.CONFIG
            full_path = glob.glob(os.path.join('**', fn))
            imports += full_path
        
        #print(imports)
        return env.File(imports)
        
    else:
        return env.File([])
#---------------------------------------------------------------------
    
#-------------------------------------------------------------------------------
#
#    Create scanners
#
    
    
CfgImportScanner = Scanner(name          = 'CfgImportScanner',
                           function      = scan_cfg_files,
                           skeys         = ['.' + ext.IP_CONFIG],
                           recursive     = True,
                           path_function = FindPathDirs('SETTINGS_SEARCH_PATH')
                          )    


#-------------------------------------------------------------------------------
#
#    Create builders
#
CreateIpScript = Builder(action         = create_ip_script,
                         suffix         = ext.TOOL_SCRIPT,
                         #src_suffix     = ext.IP_CONFIG,
                         source_scanner = CfgImportScanner)

IpCoreGen      = Builder(action     = generate_ip,
                         suffix     = ext.IP_CORE,
                         src_suffix = ext.TOOL_SCRIPT)
                 
IpCoreSyn      = Builder(action     = ip_core_synthesize,
                         suffix     = ext.DESIGN_CHECKPOINT,
                         src_suffix = ext.IP_CORE)

env['BUILDERS'] = \
{
    'CREATE_IP_SCRIPT' : CreateIpScript,
    'IP_CORE_GEN'      : IpCoreGen,
    'IP_CORE_GEN'      : IpCoreSyn
}
                   
#-------------------------------------------------------------------------------
#
#    Targets
#
def make_target_dict(src, target_ext, target_dir):
    targets = {}
    suffix = '.' + target_ext if target_ext else ''
    
    for i in src:
        name_ext   = os.path.split(i)[1]
        name       = os.path.splitext(name_ext)[0] + suffix
        targets[i] = os.path.join(target_dir, name)
        Depends(targets[i],  'SConstruct')      

    return targets

#---------------------------------------------------------------------
def make_create_ip_script_targets(ips):
    script_list = []
    
    for i in ips:
        script_list.append( env.CREATE_IP_SCRIPT(ips[i], i) )

    return script_list

#---------------------------------------------------------------------

ip_src = [os.path.join(dirs.CFG_IP, i + '.' + ext.IP_CONFIG) for i in ip]
ip_script_trg = make_target_dict(ip_src, ext.TOOL_SCRIPT, dirs.IP_SCRIPT)

create_ip_script_list = make_create_ip_script_targets(ip_script_trg)

Default(create_ip_script_list)
#-------------------------------------------------------------------------------
for i in dirs.OUTPUT:
    if not os.path.exists(i):
        print('scons: create directory "' + i + '"')
        os.makedirs(i)
#-------------------------------------------------------------------------------

