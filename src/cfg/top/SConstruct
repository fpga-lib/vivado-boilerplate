

import os
import sys
import subprocess
import re
import shutil

sys.dont_write_bytecode = True

from utils import *


#-------------------------------------------------------------------------------
#
#    General Settings
#
cfg  = import_config('main.yml')
ext  = import_config('filetype.yml')
dirs = import_config('dirpath.yml')

ConfigName = cfg.NAME
DEVICE     = cfg.DEVICE

ip       = ['pll', 'pcie']
#ip       = ['pcie']

#-------------------------------------------------------------------------------
#
#    Environment
#
env = Environment( tools = {} )

env['SETTINGS_SEARCH_PATH'] = [(dirs.CFG_SETTINGS)]

XILINX_VIVADO = os.environ['XILINX_VIVADO']

env['VIVADO']       = os.path.join(XILINX_VIVADO, 'bin', 'vivado')
env['VIVADO_FLAGS'] = ' -notrace -nojournal '

#-------------------------------------------------------------------------------
#
#    Project Structure
#



#-------------------------------------------------------------------------------
#
#    Builders
#

#---------------------------------------------------------------------
#
#    Build Tcl script to create OOC IP
#
def ip_create_script(target, source, env):

    src = str(source[0])
    trg = str(target[0])
    
    print('generate script:   \'' + os.path.basename(trg) + '\'')

    param_sect = 'config'
    
    ip_name = os.path.splitext( os.path.basename(src) )[0]   # derive IP name from full path 
    ip_cfg  = read_ip_config(src, param_sect)
    
    title_text =\
    'IP core "' + ip_name + '" creating script' + os.linesep*2 + \
    'This file is automatically generated. Do not edit the file manually,' + os.linesep + \
    'change parameters of IP in corresponing configuration file (cfg/ip/<IP name>)'
    
    text  = 'set ip_name    ' + ip_name                             + os.linesep
    text += 'set DEVICE     ' + cfg.DEVICE                          + os.linesep
    text += 'set IP_OOC_DIR ' + os.path.join(dirs.IP_OOC, ip_name)  + os.linesep*2
    text += 'set_part  ${DEVICE}'                                   + os.linesep
    text += 'create_ip -name ' + ip_cfg['type']
    text += ' -vendor xilinx.com'
    text += ' -library ip'
    text += ' -module_name ${ip_name}'
    text += ' -dir ${IP_OOC_DIR}'                                   + os.linesep*2
    
    ip_params  = ip_cfg[param_sect]
    max_pn_len = max_str_len(ip_params.keys())
    max_pv_len = max_str_len([str(i) for i in ip_params.values()])
    
    for p in ip_params:
        v             = str(ip_params[p])
        name_len      = len(p)
        value_len     = len(v)
        name_padding  = len(param_sect) + max_pn_len - name_len + 2
        value_padding = max_pv_len - value_len + 2
        line  = 'set_property ' + param_sect + '.' + p + ' '*name_padding + v 
        line += ' '*value_padding + '[get_ips ${ip_name}]'
        
        text += line + os.linesep

    text += os.linesep
    text += 'generate_target all [get_ips  ${ip_name}]'             + os.linesep
    text += 'export_ip_user_files -of_objects [get_ips ${ip_name}] '
    text += '-sync -force -quiet'                                   + os.linesep
    text += 'exit'


    out = generate_title(title_text, '#')
    out += text
    out += generate_footer('#')

    #print(out)
    
    with open(trg, 'w') as ofile:
        ofile.write(out)
    
#---------------------------------------------------------------------
#
#    Build Tcl script to synthesize OOC IP
#
def ip_syn_script(target, source, env):

    src = str(source[0])
    trg = str(target[0])

    print('generate script:   \'' + os.path.basename(trg) + '\'')

    with open(src) as src_f:
        ip_create_script = src_f.read()
        
    ip_name = re.findall('set\s+ip_name\s+(\w+)', ip_create_script)[0] # derive IP name from IP create script

    title_text =\
    'IP core "' + ip_name + '" synthesizing script' + os.linesep*2 + \
    'This file is automatically generated. Do not edit the file manually,' + os.linesep + \
    'change parameters of IP in corresponing configuration file (cfg/ip/<IP name>)'

    text  = 'set ip_name    ' + ip_name                             + os.linesep
    text += 'set DEVICE     ' + cfg.DEVICE                          + os.linesep
    text += 'set IP_OOC_DIR ' + dirs.IP_OOC                         + os.linesep
    text += 'set OUT_DIR    [file join ${IP_OOC_DIR} ${ip_name}]'   + os.linesep*2
    text += 'set_part  ${DEVICE}'                                   + os.linesep
    text += 'read_ip   [file join ${IP_OOC_DIR} ' 
    text += '${ip_name} ${ip_name} ${ip_name}.' + ext.IP_CORE +']'  + os.linesep
    text += 'synth_ip  [get_ips ${ip_name}]'                        + os.linesep
    text += 'exit'

    out = generate_title(title_text, '#')
    out += text
    out += generate_footer('#')

    #print(out)

    with open(trg, 'w') as ofile:
        ofile.write(out)

#---------------------------------------------------------------------
#
#    Generate IP
#
def ip_create(target, source, env):
    
    src     = str(source[0])
    trg     = str(target[0])
    ip_name = os.path.splitext(os.path.basename(trg))[0]
    trg_dir = os.path.join(dirs.IP_OOC, ip_name)
    logfile = os.path.join(trg_dir, 'create.log')
    flags   = env['VIVADO_FLAGS']
    
    print('create IP core     \'' + ip_name + '\'')
    
    if os.path.exists(trg_dir):
        shutil.rmtree(trg_dir)
        os.makedirs(trg_dir)
    else:
        os.makedirs(trg_dir)
        
    cmd = env['VIVADO'] + ' -mode batch ' + flags + ' -log ' + logfile + ' -source ' + src
    #print(cmd)
    rcode = pexec(cmd, trg_dir)
    return rcode
        
#    pexec('touch ' + str(target[0]))

#---------------------------------------------------------------------
#
#    Run OOC IP synthesis
#
def ip_synthesize(target, source, env):

    src     = str(source[0])
    trg     = str(target[0])
    ip_name = os.path.splitext(os.path.basename(trg))[0]
    trg_dir = os.path.join(dirs.IP_OOC, ip_name)
    logfile = os.path.join(trg_dir, 'syn.log')
    flags   = env['VIVADO_FLAGS']
    
    print('synthesize IP core \'' + ip_name + '\'')

    cmd = env['VIVADO'] + ' -mode batch ' + flags + ' -log ' + logfile + ' -source ' + src
    #print(cmd)
    rcode = pexec(cmd, trg_dir)
    return rcode
    
#    pexec('touch ' + str(target[0]))

#-------------------------------------------------------------------------------
#
#    Scanners
#
#---------------------------------------------------------------------
#
#    Scanner functions
#
def scan_cfg_files(node, env, path):
    
#    print('scan node:', str(node))    
    fname = str(node)
    with open(fname) as f:
        cfg = yaml.safe_load(f)
        
    if 'import' in cfg:
        imports = []
        for i in cfg['import'].split():
            fn = i + '.' + ext.CONFIG
            full_path = glob.glob(os.path.join('**', fn))
            imports += full_path
        
        #print(imports)
        return env.File(imports)
        
    else:
        return env.File([])
    
#---------------------------------------------------------------------
    
#-------------------------------------------------------------------------------
#
#    Create scanners
#
CfgImportScanner = Scanner(name          = 'CfgImportScanner',
                           function      = scan_cfg_files,
                           skeys         = ['.' + ext.IP_CONFIG],
                           recursive     = True,
                           path_function = FindPathDirs('SETTINGS_SEARCH_PATH')
                          )    


#-------------------------------------------------------------------------------
#
#    Create builders
#
IpCreateScript = Builder(action         = ip_create_script,
                         suffix         = ext.TOOL_SCRIPT,
                         #src_suffix     = ext.IP_CONFIG,
                         source_scanner = CfgImportScanner)

IpSynScript    = Builder(action         = ip_syn_script,
                         suffix         = ext.TOOL_SCRIPT
                        )

IpCreate       = Builder(action     = ip_create,
                         suffix     = ext.IP_CORE,
                         src_suffix = ext.TOOL_SCRIPT)
                 
IpSyn          = Builder(action     = ip_synthesize,
                         suffix     = ext.DESIGN_CHECKPOINT,
                         src_suffix = ext.IP_CORE)

env['BUILDERS'] = \
{
    'IP_CREATE_SCRIPT' : IpCreateScript,
    'IP_SYN_SCRIPT'    : IpSynScript,
    'IP_CREATE'        : IpCreate,
    'IP_SYN'           : IpSyn
}
                   
#-------------------------------------------------------------------------------
#
#    Targets
#
def make_trg_nodes(src, src_suffix, trg_suffix, trg_dir, builder):
    
    if type(src) != str:
        s0 = str(src[0])
    else:
        s0 = src
        
#   if type(s0) != str:
#       s0 = str(s0)
        
#    print(s0)
#    print(src)
        
    src_name = os.path.split(s0)[1]
    trg_name = src_name.replace(src_suffix, trg_suffix)
#    print(src_name, trg_name)
    trg      = os.path.join(trg_dir, trg_name)
    trg_list = builder(trg, src)
        
    Depends(trg_list, 'SConstruct')
    return trg_list

#---------------------------------------------------------------------
#
#    Processing OOC IP targets
#

ipcs   = []      # IP Create Scripts
ipss   = []      # IP Synth Scripts
ip_xci = []
ip_dcp = []      

for i in ip:
    ip_src = os.path.join(dirs.CFG_IP, i + '.' + ext.IP_CONFIG)

    # Generating create IP script targets
    ip_create_script_nodes = make_trg_nodes(ip_src, 
                                            '.'+ext.IP_CONFIG, 
                                            '-create.'+ext.TOOL_SCRIPT, 
                                            dirs.IP_SCRIPT,
                                            env.IP_CREATE_SCRIPT)
    ipcs.append(ip_create_script_nodes)

    # Generating synthesize IP script targets
    ip_syn_script_nodes = make_trg_nodes(ip_create_script_nodes, 
                                         '-create.'+ext.TOOL_SCRIPT, 
                                         '-syn.'+ext.TOOL_SCRIPT, 
                                         dirs.IP_SCRIPT,
                                         env.IP_SYN_SCRIPT)
    ipss.append(ip_syn_script_nodes)
    
    # Creating IP core targets
    ip_nodes = make_trg_nodes(ip_create_script_nodes, 
                              '-create.'+ext.TOOL_SCRIPT, 
                              '.'+ext.IP_CORE, 
                              os.path.join( dirs.IP_OOC, i, i ),
                              env.IP_CREATE)

    ip_xci.append(ip_nodes)
    
    # Synthesizing OOC IP core targets
    ip_ooc_syn_nodes = make_trg_nodes(ip_syn_script_nodes + ip_nodes,
                                      '-syn.'+ext.TOOL_SCRIPT, 
                                      '.'+ext.DESIGN_CHECKPOINT, 
                                      os.path.join( dirs.IP_OOC, i, i ),
                                      env.IP_SYN)
    
    ip_dcp.append(ip_ooc_syn_nodes)
#Default(ip_create_script_nodes)
Default(ip_dcp)
#-------------------------------------------------------------------------------



#-------------------------------------------------------------------------------
for i in dirs.OUTPUT:
    if not os.path.exists(i):
        print('scons: create directory "' + i + '"')
        os.makedirs(i)
#-------------------------------------------------------------------------------

